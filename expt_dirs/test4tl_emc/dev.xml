<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE workflow [

<!--
SECTION 1:
Variables that are modified by the workflow generation script.
-->

<!--
The following are variables that are not passed to the shell scripts 
that execute the various worklflow tasks but are used in other ways by
the workflow XML.
-->
<!ENTITY ACCOUNT       "fv3-cam">
<!ENTITY USER "Ting.Lei">
<!ENTITY SCHED         "slurm"> 
<!ENTITY QUEUE_DEFAULT "batch">
<!ENTITY QUEUE_HPSS    "service">
<!ENTITY QUEUE_FCST    "batch">
<!ENTITY EXPenvir    "testXXXX">


<!ENTITY USHDIR  "/scratch2/NCEPDEV/fv3-cam/Ting.Lei/dr-regional-workflow/tl-fork_unified-workflow/regional_workflow/ush">
<!ENTITY JOBSDIR "/scratch2/NCEPDEV/fv3-cam/Ting.Lei/dr-regional-workflow/tl-fork_unified-workflow/regional_workflow/jobs">
<!ENTITY EXPTDIR "/scratch2/NCEPDEV/fv3-cam/Ting.Lei/dr-regional-workflow/tl-fork_unified-workflow/expt_dirs/test4tl_emc">
<!ENTITY LOGDIR  "/scratch2/NCEPDEV/fv3-cam/Ting.Lei/dr-regional-workflow/tl-fork_unified-workflow/expt_dirs/test4tl_emc/log">

<!ENTITY EXTRN_MDL_NAME_ICS  "FV3GFS">
<!ENTITY EXTRN_MDL_NAME_LBCS "FV3GFS">

<!ENTITY EXTRN_MDL_FILES_SYSBASEDIR_ICS  "/scratch1/NCEPDEV/rstprod/com/gfs/prod">
<!ENTITY EXTRN_MDL_FILES_SYSBASEDIR_LBCS "/scratch1/NCEPDEV/rstprod/com/gfs/prod">

<!ENTITY DATE_FIRST_CYCL "20200417">
<!ENTITY DATE_LAST_CYCL  "20200417">
<!ENTITY YYYY_FIRST_CYCL "2020">
<!ENTITY MM_FIRST_CYCL   "04">
<!ENTITY DD_FIRST_CYCL   "17">
<!ENTITY HH_FIRST_CYCL   "00">

<!ENTITY FHR "00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48">
<!ENTITY FHR_tm12 "00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24">
<!ENTITY FHR_hourly "00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24">

<!ENTITY RUN_TASK_MAKE_GRID      "FALSE">
<!ENTITY RUN_TASK_MAKE_OROG      "FALSE">
<!ENTITY RUN_TASK_MAKE_SFC_CLIMO "FALSE">

<!--
The following are variables that are passed to the shell scripts that 
execute the various workflow tasks but are not otherwise used in the 
workflow XML.
-->
<!ENTITY GLOBAL_VAR_DEFNS_FP "/scratch2/NCEPDEV/fv3-cam/Ting.Lei/dr-regional-workflow/tl-fork_unified-workflow/expt_dirs/test4tl_emc/var_defns.sh">
<!ENTITY CYCLE_DIR           "/scratch2/NCEPDEV/stmp3/&USER;/tmpnwprd/conus_@Y@m@d@H">

<!-- 
Task names.
-->
<!ENTITY MAKE_GRID_TN      "make_grid">
<!ENTITY MAKE_OROG_TN      "make_orog">
<!ENTITY MAKE_SFC_CLIMO_TN "make_sfc_climo">
<!ENTITY GET_EXTRN_ICS_TN  "get_extrn_ics">
<!ENTITY GET_EXTRN_LBCS_TN "get_extrn_lbcs">
<!ENTITY MAKE_ICS_TN       "make_ics">
<!ENTITY MAKE_LBCS_TN      "make_lbcs">
<!ENTITY RUN_FCST_TN       "run_fcst">
<!ENTITY RUN_GSIANL_TN       "run_gsianl">
<!ENTITY RUN_POST_TN       "run_post">

<!--
SECTION 2:
Variables that are not modified by the workflow generation script.
-->

<!ENTITY PROC_MAKE_GRID           "1:ppn=24">
<!ENTITY PROC_MAKE_OROG           "1:ppn=24">
<!ENTITY PROC_MAKE_SFC_CLIMO      "2:ppn=24">
<!ENTITY PROC_GET_EXTRN_MDL_FILES "1:ppn=1">
<!ENTITY PROC_MAKE_ICS_SURF_LBC0  "4:ppn=12">
<!ENTITY PROC_MAKE_LBC1_TO_LBCN   "4:ppn=12">
<!ENTITY PROC_RUN_FCST            "72:ppn=20:tpp=2">
<!ENTITY PROC_RUN_GSIANL          "10:ppn=24">
<!ENTITY PROC_POST                "2:ppn=14">

<!ENTITY RSRC_MAKE_GRID           "<walltime>00:10:00</walltime>">
<!ENTITY RSRC_MAKE_OROG           "<walltime>00:10:00</walltime>">
<!ENTITY RSRC_MAKE_SFC_CLIMO      "<walltime>00:25:00</walltime>">
<!ENTITY RSRC_GET_EXTRN_MDL_FILES "<walltime>00:45:00</walltime>">
<!ENTITY RSRC_MAKE_ICS_SURF_LBC0  "<walltime>00:30:00</walltime>">
<!ENTITY RSRC_MAKE_LBC1_TO_LBCN   "<walltime>01:00:00</walltime>">
<!ENTITY RSRC_RUN_FCST            "<walltime>02:30:00</walltime>">
<!ENTITY RSRC_RUN_GSIANL          "<walltime>00:30:00</walltime>">
 
<!ENTITY RSRC_POST                "<walltime>00:30:00</walltime>">

<!ENTITY RSRV_DEFAULT  "<queue>&QUEUE_DEFAULT;</queue><account>&ACCOUNT;</account>"> 
<!ENTITY RSRV_HPSS     "<partition>&QUEUE_HPSS;</partition><account>&ACCOUNT;</account>"> 
<!ENTITY RSRV_RUN_FCST "<queue>&QUEUE_FCST;</queue><account>&ACCOUNT;</account>"> 
<!ENTITY RSRV_RUN_GSIANL "<queue>debug</queue><account>&ACCOUNT;</account>"> 

<!ENTITY nens '81'> 
<!ENTITY gsiexec 'testTT'> 
<!ENTITY regional_ensemble_option '1'> 
<!ENTITY PRE "/scratch2/NCEPDEV/fv3-cam/Ting.Lei/dr-regional-workflow/regional_workflow//rocoto/rocoto_pre_job.sh"> 


<!-- 
Shell script to load task-specific modules and then run the task (while
killing itelf off) using the exec command.
-->
<!ENTITY LOAD_MODULES_RUN_TASK_FP "&USHDIR;/load_modules_run_task.sh">

]>

<workflow realtime="F" scheduler="&SCHED;" cyclethrottle="20">

  <cycledef group="at_start">00 &HH_FIRST_CYCL; &DD_FIRST_CYCL; &MM_FIRST_CYCL; &YYYY_FIRST_CYCL; *</cycledef>
  <cycledef group="at_00Z">&DATE_FIRST_CYCL;0000 &DATE_LAST_CYCL;0000 24:00:00</cycledef>
  <cycledef group="at_12Z">&DATE_FIRST_CYCL;1200 &DATE_LAST_CYCL;1200 24:00:00</cycledef>
  <cycledef group="regional">&DATE_FIRST_CYCL;0000 &DATE_LAST_CYCL;0000 24:00:00</cycledef>

  <log>
    <cyclestr>&LOGDIR;/FV3SAR_wflow.log</cyclestr>
  </log>
<!--
************************************************************************
************************************************************************
-->
  <task name="&MAKE_GRID_TN;" cycledefs="at_start" maxtries="4">

    &RSRC_MAKE_GRID;
    &RSRV_DEFAULT;
<!-- 
The following command works if we do NOT call exec in LOAD_MODULES_RUN_-
TASK_FP to run the J-job.  This just sources the LOAD_MODULES_RUN_TASK_-
FP before running the J-job, so it is simpler than calling exec and thus
preferred if NCO accepts it.  Note that while sourcing LOAD_MODULES_-
RUN_TASK_FP, it also passes an argument along (the name of the task), 
and that works in bash (but it probably won't work in sh).  

If this method is acceptable to NCO, then for clarity maybe we can 
source LOAD_MODULES_RUN_TASK_FP within the J-job instead of here since 
we have are already sourcing other files in the J-job anyway.
-->
<!-- 
    <command>{ . &LOAD_MODULES_RUN_TASK_FP; "&MAKE_GRID_TN;"; 
               &JOBSDIR;/JREGIONAL_MAKE_GRID;
             }</command>
-->
<!-- 
The following command works if we call exec in LOAD_MODULES_RUN_TASK_FP
to run the J-job.  This passes the J-job script as the second argument 
to LOAD_MODULES_RUN_TASK_FP (the first argument is the task name).  The
J-job then uses exec to run the J-job (while also terminating the LOAD_-
MODULES_RUN_TASK_FP script.
-->
    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_GRID_TN;" "&JOBSDIR;/JREGIONAL_MAKE_GRID"</command>
    <nodes>&PROC_MAKE_GRID;</nodes>
    <jobname>&MAKE_GRID_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_GRID_TN;.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>

    <dependency>
      <streq><left>&RUN_TASK_MAKE_GRID;</left><right>TRUE</right></streq>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&MAKE_OROG_TN;" cycledefs="at_start" maxtries="4">

    &RSRC_MAKE_OROG;
    &RSRV_DEFAULT;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_OROG_TN;" "&JOBSDIR;/JREGIONAL_MAKE_OROG"</command>
    <nodes>&PROC_MAKE_OROG;</nodes>
    <jobname>&MAKE_OROG_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_OROG_TN;.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>

    <dependency>
      <and>
        <streq><left>&RUN_TASK_MAKE_OROG;</left><right>TRUE</right></streq>
        <or>
<!--          <taskdep task="make_grid"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/make_grid_task_complete.txt</datadep>	
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&MAKE_SFC_CLIMO_TN;" cycledefs="at_start" maxtries="2">

    &RSRC_MAKE_SFC_CLIMO;
    &RSRV_DEFAULT;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_SFC_CLIMO_TN;" "&JOBSDIR;/JREGIONAL_MAKE_SFC_CLIMO"</command>
    <nodes>&PROC_MAKE_SFC_CLIMO;</nodes>
    <jobname>&MAKE_SFC_CLIMO_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_SFC_CLIMO_TN;.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>

    <dependency>
      <and>
        <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>TRUE</right></streq>
        <or>
<!--          <taskdep task="make_grid"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/make_grid_task_complete.txt</datadep>	
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_OROG_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_OROG_TN;_task_complete.txt</datadep>	
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&GET_EXTRN_ICS_TN;" maxtries="3">

    &RSRC_GET_EXTRN_MDL_FILES;
    &RSRV_HPSS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&GET_EXTRN_ICS_TN;" "&JOBSDIR;/dev-JREGIONAL_GET_EXTRN_FILES"</command>
    <nodes>&PROC_GET_EXTRN_MDL_FILES;</nodes>
    <jobname>&GET_EXTRN_ICS_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&GET_EXTRN_ICS_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>EXTRN_MDL_NAME</name><value>&EXTRN_MDL_NAME_ICS;</value></envar>
    <envar><name>ICS_OR_LBCS</name><value>ICS</value></envar>
    <envar>
      <name>tmmark</name>
      <value>tm12</value>
    </envar>

  </task> 
<!--
************************************************************************
************************************************************************
-->
<metatask name="&GET_EXTRN_LBCS_TN;"> 
  <var name="mark">12 06 05 04 03 02 01 00</var>
  <task name="&GET_EXTRN_LBCS_TN;_tm#mark#" maxtries="3">

    &RSRC_GET_EXTRN_MDL_FILES;
    &RSRV_HPSS;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&GET_EXTRN_LBCS_TN;" "&JOBSDIR;/dev-JREGIONAL_GET_EXTRN_FILES"</command>
    <nodes>&PROC_GET_EXTRN_MDL_FILES;</nodes>
    <jobname>&GET_EXTRN_LBCS_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&GET_EXTRN_LBCS_TN;tm#mark#_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>EXTRN_MDL_NAME</name><value>&EXTRN_MDL_NAME_LBCS;</value></envar>
    <envar><name>ICS_OR_LBCS</name><value>LBCS</value></envar>
    <envar>
      <name>tmmark</name>
      <value>tm#mark#</value>
    </envar>

  </task> 
  </metatask> 
<!--
************************************************************************
************************************************************************
-->
  <task name="&MAKE_ICS_TN;" maxtries="3">

    &RSRC_MAKE_ICS_SURF_LBC0;
    &RSRV_DEFAULT;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_ICS_TN;" "&JOBSDIR;/dev-JREGIONAL_MAKE_ICS"</command>
    <nodes>&PROC_MAKE_ICS_SURF_LBC0;</nodes>
    <jobname>&MAKE_ICS_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_ICS_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar>
      <name>tmmark</name>
      <value>tm12</value>
    </envar>

    <dependency>
      <and>
        <taskdep task="&GET_EXTRN_ICS_TN;"/>
        <or>
<!--          <taskdep task="make_grid"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/make_grid_task_complete.txt</datadep>	
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_OROG_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_OROG_TN;_task_complete.txt</datadep>	
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_SFC_CLIMO_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_SFC_CLIMO_TN;_task_complete.txt</datadep>	
          <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&MAKE_LBCS_TN;" maxtries="3">

    &RSRC_MAKE_LBC1_TO_LBCN;
    &RSRV_DEFAULT;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_LBCS_TN;" "&JOBSDIR;/dev-JREGIONAL_MAKE_LBCS"</command>
    <nodes>&PROC_MAKE_LBC1_TO_LBCN;</nodes>
    <jobname>&MAKE_LBCS_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_LBCS_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar>
      <name>tmmark</name>
      <value>tm12</value>
    </envar>

    <dependency>
      <and>
<!--        <metataskdep metatask="&GET_EXTRN_LBCS_TN;"/> cltthink -->
        <taskdep task="&GET_EXTRN_LBCS_TN;_tm12"/>
        <or>
<!--          <taskdep task="make_grid"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/make_grid_task_complete.txt</datadep>	
          <streq><left>&RUN_TASK_MAKE_GRID;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_OROG_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_OROG_TN;_task_complete.txt</datadep>	
          <streq><left>&RUN_TASK_MAKE_OROG;</left><right>FALSE</right></streq>
        </or>
        <or>
<!--          <taskdep task="&MAKE_SFC_CLIMO_TN;"/> -->
          <datadep age="00:00:00:05">&LOGDIR;/&MAKE_SFC_CLIMO_TN;_task_complete.txt</datadep>	
          <streq><left>&RUN_TASK_MAKE_SFC_CLIMO;</left><right>FALSE</right></streq>
        </or>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <task name="&RUN_FCST_TN;" maxtries="3">

    &RSRC_RUN_FCST;
    &RSRV_RUN_FCST;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_FCST_TN;" "&JOBSDIR;/dev-JREGIONAL_RUN_FCST"</command>
    <nodes>&PROC_RUN_FCST;</nodes>
    <jobname>&RUN_FCST_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&RUN_FCST_TN;_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar>
      <name>tmmark</name>
      <value>tm12</value>
    </envar>
    <envar>
      <name>CYCLE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>job</name>
      <value>forecast_firstguess</value>
    </envar>
    <envar>
      <name>FCST_LEN_HRS</name>
      <value>6</value>
    </envar>
    <envar>
      <name>LBC_UPDATE_INTVL_HRS</name>
      <value>3</value>
    </envar>

    <dependency>
      <and>
        <taskdep task="&MAKE_ICS_TN;"/>
        <taskdep task="&MAKE_LBCS_TN;"/>
      </and>
    </dependency>

  </task>
<!--
************************************************************************
************************************************************************
-->
  <metatask name="&RUN_POST_TN;_init_fcst">
    
    <var name="fhr">&FHR_tm12;</var>
    
    <task name="&RUN_POST_TN;_init_fcst_fhr#fhr#" maxtries="2">
    
      &RSRC_POST;
      &RSRV_DEFAULT;

      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_POST_TN;" "&JOBSDIR;/dev-JREGIONAL_RUN_POST"</command>
      <nodes>&PROC_POST;</nodes>
      <jobname>&RUN_POST_TN;_init_fcst;_fhr#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&RUN_POST_TN;_init_fcst_#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar>
        <name>tmmark</name>
        <value>tm12</value>
      </envar>
    <envar>
      <name>fcst_job</name>
      <value>forecast_firstguess</value>
    </envar>

      <dependency>
          <taskdep task="&RUN_FCST_TN;"/>
      </dependency>

    </task>

  </metatask>
<metatask name="chgres_fcstbndy_da">
  <var name="mark">01 02 03 04 05 06</var>
  <task name="chgres_fcstbndy_tm#mark#" maxtries="3">

    &RSRC_MAKE_LBC1_TO_LBCN;
    &RSRV_DEFAULT;

    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_LBCS_TN;" "&JOBSDIR;/dev-JREGIONAL_MAKE_LBCS"</command>
    <nodes>&PROC_MAKE_LBC1_TO_LBCN;</nodes>
    <jobname>&MAKE_LBCS_TN;</jobname>
    <join><cyclestr>&LOGDIR;/&MAKE_LBCS_TN;tm#mark#_@Y@m@d@H.log</cyclestr></join>

    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar>
      <name>tmmark</name>
      <value>tm#mark#</value>
    </envar>
    <envar>
      <name>job</name>
      <value>chgres_fcstbndy_tm#mark#</value>
    </envar>

    <dependency>
<!--        <metataskdep metatask="&GET_EXTRN_LBCS_TN;"/> cltthink -->
        <taskdep task="&GET_EXTRN_LBCS_TN;_tm12"/>
    </dependency>

  </task>
</metatask>

  <task name="analysis_tm06" cycledefs="regional" maxtries="6">
    &RSRC_RUN_GSIANL;
    &RSRV_RUN_GSIANL;
   <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_GSIANL_TN;"  "&JOBSDIR;/dev-JREGIONAL_RUN_ANAL"</command>
    <nodes>&PROC_RUN_GSIANL;</nodes>
    <jobname><cyclestr>gsianl_tm06_@H</cyclestr></jobname>
    <join><cyclestr>&LOGDIR;/dr@Y@m@d@H.log/gsianl_firstguess_tm06_@H.log</cyclestr></join>
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar>
      <name>envir</name>
      <value>&EXPenvir;</value>
    </envar>
    <envar>
      <name>regional_ensemble_option</name>
      <value>&regional_ensemble_option;</value>
    </envar>

    <envar>
      <name>job</name>
      <value>gsianl_tm06</value>
    </envar>
    <envar>
      <name>tmmark</name>
      <value>tm06</value>
    </envar>
    <envar>
      <name>USER</name>
      <value>&USER;</value>
    </envar>
    <envar>
      <name>CYCLE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
    </envar>
     <envar>
      <name>gsiexec</name>
      <value>&gsiexec;</value>
     </envar>
  
    <envar>
      <name>nens </name>
      <value>&nens; </value>
     </envar>

    
      <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>

    <dependency>
        <taskdep task="&RUN_FCST_TN;"/>
    </dependency>

  </task>
  <metatask name="da_fcst_analysis_set">
    <var name="mark">06 05 04 03 02</var>
    <var name="next_mark">05 04 03 02 01</var>

    <task name="forecast_tm#mark#" cycledefs="regional" maxtries="6">
    &RSRC_RUN_FCST;
    &RSRV_RUN_FCST;
<!-- cltorg   <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_FCST_TN;"  "&JOBSDIR;/dev-JREGIONAL_RUN_FCST"</command> -->
    <command>&PRE;   "&JOBSDIR;/dev-JREGIONAL_RUN_FCST"</command>
    <nodes>&PROC_RUN_FCST;</nodes>
     <jobname><cyclestr>forecast_tm#mark#_@H</cyclestr></jobname>
     <join><cyclestr>&LOGDIR;/dr@Y@m@d@H.log/forecast_tm#mark#_@H.log</cyclestr></join>
    <envar>
      <name>envir</name>
      <value>&EXPenvir;</value>
    </envar>
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
     <envar>
      <name>job</name>
      <value>forecast_tm#mark#</value>
     </envar>

     <envar>
      <name>tmmark</name>
      <value>tm#mark#</value>
     </envar>
     <envar>
      <name>CYCLE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
     </envar>

     <dependency>
      <and>
       <taskdep task="analysis_tm#mark#"/>
       <taskdep task="chgres_fcstbndy_tm#mark#"/>
      </and>
     </dependency>

  </task>

  <task name="analysis_tm#next_mark#" cycledefs="regional" maxtries="6">
    &RSRC_RUN_GSIANL;
    &RSRV_RUN_GSIANL;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_GSIANL_TN;"  "&JOBSDIR;/dev-JREGIONAL_RUN_ANAL"</command>
    <nodes>&PROC_RUN_GSIANL;</nodes>
    <jobname><cyclestr>gsianl_tm#next_mark#_@H</cyclestr></jobname>
    <join><cyclestr>&LOGDIR;/dr@Y@m@d@H.log/gsianl_tm#next_mark#_@H.log</cyclestr></join>
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar>
      <name>envir</name>
      <value>&EXPenvir;</value>
    </envar>
    <envar>
      <name>regional_ensemble_option</name>
      <value>&regional_ensemble_option;</value>
    </envar>

    <envar>
      <name>job</name>
      <value>gsianl_tm#next_mark#</value>
    </envar>
    <envar>
      <name>tmmark</name>
      <value>tm#next_mark#</value>
    </envar>
    <envar>
      <name>USER</name>
      <value>&USER;</value>
    </envar>
    <envar>
      <name>CYCLE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
    </envar>


     <envar>
      <name>gsiexec</name>
      <value>&gsiexec;</value>
     </envar>

    <envar>
      <name>nens </name>
      <value>&nens; </value>
     </envar>

    



      <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>



    <dependency>
        <taskdep task="forecast_tm#mark#"/>
    </dependency>
   </task>

  </metatask>
<!--  ***********************************************************************  -->
<!--  ********** Run the post jobs for tm06-tm01 *****************************  -->
<!--  ***********************************************************************  -->


<!--  ***********************************************************************  -->
<!--  ********** Run the post jobs for tm06-tm01 *****************************  -->
<!--  ***********************************************************************  -->

   <metatask name="post_tm06-01" >
   <var name="mark">06 05 04 03 02 01</var>
   <metatask>
    <var name="fhr">00 01</var>
    <task name="post_f#fhr#_tm#mark#" cycledefs="regional" maxtries="6">
      &RSRC_POST;
      &RSRV_DEFAULT;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_POST_TN;" "&JOBSDIR;/dev-JREGIONAL_RUN_POST"</command>
      <nodes>&PROC_POST;</nodes>
      <jobname><cyclestr>post_f#fhr#_tm#mark#_@H</cyclestr></jobname>
      <join><cyclestr>&LOGDIR;/dr@Y@m@d@H.log/post_f#fhr#_tm#mark#_@H.log</cyclestr></join>
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar>
      <name>envir</name>
      <value>&EXPenvir;</value>
    </envar>

      <envar>
        <name>job</name>
        <value>post_f#fhr#_tm#mark#</value>
      </envar>
      <envar>
        <name>fhr</name>
        <value>#fhr#</value>
      </envar>
      <envar>
        <name>tmmark</name>
        <value>tm#mark#</value>
      </envar>
      <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>fcst_job</name>
      <value>forecast_tm#mark#</value>
    </envar>

      <dependency>
         <metataskdep metatask="da_fcst_analysis_set"/>
      </dependency>
    </task>
   </metatask>
  </metatask>
<!--  ***********************************************************************  -->
<!--  ********** Run the tm01 fcst - tm00 analysis as a metatask*************  -->
<!--  ***********************************************************************  -->

  <metatask name="fcsttm01_anltm00">
    <var name="mark">01</var>
    <var name="next_mark">00</var>

    <task name="forecast_tm#mark#" cycledefs="regional" maxtries="6">
    &RSRC_RUN_FCST;
    &RSRV_RUN_FCST;
<!--     <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_FCST_TN;" "&JOBSDIR;/dev-JREGIONAL_RUN_FCST"</command> -->
    <command>&PRE;   "&JOBSDIR;/dev-JREGIONAL_RUN_FCST"</command>
    <nodes>&PROC_RUN_FCST;</nodes>
     <jobname><cyclestr>forecast_tm#mark#_@H</cyclestr></jobname>
     <join><cyclestr>&LOGDIR;/dr@Y@m@d@H.log/forecast_tm#mark#_@H.log</cyclestr></join>
    <envar>
      <name>envir</name>
      <value>&EXPenvir;</value>
    </envar>
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>

     <envar>
      <name>job</name>
      <value>forecast_tm#mark#</value>
     </envar>


     <envar>
      <name>tmmark</name>
      <value>tm#mark#</value>
     </envar>

     <dependency>
      <and>
       <taskdep task="analysis_tm#mark#"/>
       <taskdep task="chgres_fcstbndy_tm#mark#"/>
      </and>
     </dependency>

  </task>

  <task name="analysis_tm#next_mark#" cycledefs="regional" maxtries="6">
    &RSRC_RUN_GSIANL;
    &RSRV_RUN_GSIANL;
   <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_GSIANL_TN;"  "&JOBSDIR;/dev-JREGIONAL_RUN_ANAL"</command>
    <nodes>&PROC_RUN_GSIANL;</nodes>
    <jobname><cyclestr>gsianl_tm#next_mark#_@H</cyclestr></jobname>
    <join><cyclestr>&LOGDIR;/dr@Y@m@d@H.log/gsianl_tm#next_mark#_@H.log</cyclestr></join>
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar>
      <name>envir</name>
      <value>&EXPenvir;</value>
    </envar>

    <envar>
      <name>job</name>
      <value>gsianl_tm#next_mark#</value>
    </envar>
    <envar>
      <name>tmmark</name>
      <value>tm#next_mark#</value>
    </envar>
    <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
    </envar>

     <envar>
      <name>gsiexec</name>
      <value>&gsiexec;</value>
     </envar>

    <envar>
      <name>nens </name>
      <value>&nens; </value>
     </envar>
      <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>



    <dependency>
        <taskdep task="forecast_tm#mark#"/>
    </dependency>
   </task>

  </metatask>
<!-- Create the boundary conditions for the 60-h forecast -->
  <task name="chgres_fcstbndy_tm00" cycledefs="regional" maxtries="6">

    &RSRC_MAKE_LBC1_TO_LBCN;
    &RSRV_DEFAULT;
    <command>&LOAD_MODULES_RUN_TASK_FP; "&MAKE_LBCS_TN;" "&JOBSDIR;/dev-JREGIONAL_MAKE_LBCS"</command>
    <nodes>&PROC_MAKE_LBC1_TO_LBCN;</nodes>
    <jobname><cyclestr> chgres_fcstbndy_tm00_@H</cyclestr></jobname>
    <join><cyclestr>&LOGDIR;/dr@Y@m@d@H.log/chgres_fcstbndy.tm00_@H.log</cyclestr></join>
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar>
      <name>envir</name>
      <value>&EXPenvir;</value>
    </envar>
    <envar>
     <name>job</name>
     <value>chgres_fcstbndy_tm00</value>
    </envar>
    <envar>
      <name>tmmark</name>
      <value>tm00</value>
    </envar>
      <envar>
      <name>CDATE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>

    <dependency>
       <taskdep task="analysis_tm00"/>
    </dependency>

  </task>
<!-- Send tm00 IC/BC to FTP Server -->

<!--  ***********************************************************************  -->
<!--  ************************* Run the 60-h forecast ***********************  -->

  <task name="forecast_tm00" cycledefs="regional" maxtries="6">
<!--    <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_FCST_TN;" "&JOBSDIR;/dev-JREGIONAL_RUN_FCST"</command> -->
    <command>&PRE;   "&JOBSDIR;/dev-JREGIONAL_RUN_FCST"</command>
    <jobname><cyclestr>forecast_tm00_@H</cyclestr></jobname>
    <join><cyclestr>&LOGDIR;/dr@Y@m@d@H.log/forecast_tm00_@H.log</cyclestr></join>
    &RSRC_RUN_FCST;
    &RSRV_RUN_FCST;
    <nodes>&PROC_RUN_FCST;</nodes>
    <envar>
      <name>envir</name>
      <value>&EXPenvir;</value>
    </envar>
    <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
    <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
    <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>

    <envar>
     <name>job</name>
     <value>forecast_tm00</value>
    </envar>
    <envar>
      <name>tmmark</name>
      <value>tm00</value>
    </envar>
    <envar>
      <name>USER</name>
      <value>&USER;</value>
    </envar>
    <envar>
      <name>CYCLE</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>cyc</name>
      <value><cyclestr>@H</cyclestr></value>
    </envar>
    <envar>
      <name>PDY</name>
      <value><cyclestr>@Y@m@d</cyclestr></value>
    </envar>

    <dependency>
      <and>
        <taskdep task="analysis_tm00"/>
        <taskdep task="chgres_fcstbndy_tm00"/>
      </and>
    </dependency>

  </task>
  <metatask name="&RUN_POST_TN;_tm00_fcst">
    
    <var name="fhr">&FHR_tm12;</var>
    
    <task name="&RUN_POST_TN;_tm00_fcst_fhr#fhr#" maxtries="2">
    
      &RSRC_POST;
      &RSRV_DEFAULT;
      <command>&LOAD_MODULES_RUN_TASK_FP; "&RUN_POST_TN;" "&JOBSDIR;/dev-JREGIONAL_RUN_POST"</command>
      <nodes>&PROC_POST;</nodes>
      <jobname>&RUN_POST_TN;_tm00_fcst_fhr#fhr#</jobname>
      <join><cyclestr>&LOGDIR;/&RUN_POST_TN;_tm00_fcst_#fhr#_@Y@m@d@H.log</cyclestr></join>

      <envar><name>GLOBAL_VAR_DEFNS_FP</name><value>&GLOBAL_VAR_DEFNS_FP;</value></envar>
      <envar><name>CYCLE_DIR</name><value><cyclestr>&CYCLE_DIR;</cyclestr></value></envar>
      <envar><name>CDATE</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
      <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
      <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
      <envar><name>fhr</name><value>#fhr#</value></envar>
      <envar>
        <name>tmmark</name>
        <value>tm00</value>
      </envar>
    <envar>
      <name>fcst_job</name>
      <value>forecast_tm00</value>
    </envar>

      <dependency>
          <taskdep task="forecast_tm00"/>
      </dependency>

    </task>

  </metatask>

</workflow>
